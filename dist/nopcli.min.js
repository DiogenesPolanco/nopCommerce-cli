#! /usr/bin/env node
import e from"yargs";import{getInstalledPath as t}from"get-installed-path";import n from"shelljs";import a from"fs";import s from"cli-progress";class i{static getPath(){return t("nopcli")}static getGroupAlias(){return{alias:"group",type:"string",default:"Widgets",describe:"support Widgets, Payments, DiscountRules, Shipping and Misc"}}static getVersionAlias(){return{alias:"version",type:"number",default:430,describe:'Only support ["4.20", "4.30", "4.40", "4.50"]'}}static getPluginAlias(){return{alias:"plugin",type:"string"}}static getClearAlias(){return{alias:"clear",type:"boolean",default:!1}}static getDescriptionNewCommand(){return"create plugin -[g] -[p] -[v] -[c]"}static getDescriptionBuildCommand(){return"build plugin -[g] -[p]"}static getDescriptionDemand(){return"please choose a valid command"}}class r{static printHandler(e,t){let a=e,s=t;a?n.echo(`${a.code}:${a.message}`):n.echo(`${s.message}`)}}let l;l={"001":{message:"Error during the generation of the plugin",code:"001"},"002":{message:"The creation of the plugin was successful",code:"002"},"003":{message:"Error while building plugin",code:"003"},"004":{message:"The build of the plugin was successful",code:"004"},"005":{message:"Error while get value",code:"005"},"006":{message:"Creating the plugin, Please Wait...",code:"006"}};class c{getSrcPluginName(e){return`Nop.Plugin.${e.g}.NopCliGeneric`}getOutPluginName(e){return`Nop.Plugin.${e.g}.${e.p}`}getFullSrcPlugin(e){return`${this.getSrcSolutionPath(e)}/Plugins/${this.getOutPluginName(e)}`}getSrcSolutionPath(){return a.existsSync("Plugins")?".":"src"}async validateVersion(e){let t=this.getSrcSolutionPath();return await a.existsSync(`${t}/Libraries/Nop.Services/Plugins/Samples/uploadedItems.json`)&&a.readFile(`${t}/Libraries/Nop.Services/Plugins/Samples/uploadedItems.json`,"utf8",((t,n)=>{if(t)throw t;let a=JSON.parse(n.replace(new RegExp("//(.*)","g"),""));e=a[3].SupportedVersion})),e}async getSrcVersion(e){let t=void 0!==e.v&&420!==e.v?450===e.v?440:e.v:430;return await this.validateVersion(t)}getOutProjectPathPluginName(e){return`${this.getFullSrcPlugin(e)}/${this.getOutPluginName(e)}.csproj`}async existOutProjectAsync(e){let t=this;return new Promise((async(n,s)=>{let i=t.getOutProjectPathPluginName(e);void 0===i?s(l["005"]):n(await a.existsSync(i))}))}async copyFiles(e,t){let s=this;return new Promise((async(i,r)=>{let l=s.getFullSrcPlugin(t),c=s.getSrcPluginName(t),o=s.getOutPluginName(t);n.mkdir("-p",`${l}`),n.cp("-R",`${e}/src/nopCommerce-${await s.getSrcVersion(t)}/${c}/`,l),n.mv(`${l}/${c}.csproj`,`${l}/${o}.csproj`),await a.readFileSync(`${e}/src/assets/images/logos/logo.png`,(function(e,t){e?i(!1):a.writeFile(`${l}/logos.png`,t,"base64",(function(e){e&&i(!1)}))})),i(!0)}))}async replaceContentFiles(e){let t=this;return new Promise((async s=>{let i=t.getFullSrcPlugin(e),r=n.find(`${i}`);if(r.length>0){for(const t of r)a.lstat(t,((a,s)=>{if(s.isFile()){let a=t.replace("NopCliGeneric",e.p);n.sed("-i",/NopCliGeneric/g,e.p,t),a!==t&&n.mv(`${t}`,`${a}`)}}));s(!0)}else s(!1)}))}async addSolution(e){let t=this;return new Promise((async(i,c)=>{await a.existsSync(`${t.getSrcSolutionPath()}/NopCommerce.sln`)?(r.printHandler(null,l["006"]),n.config.silent=!0,class{static waitProgress(e=s.Presets.shades_classic,t=0,n=100,a=10){let i=this,r=new s.Bar({format:"progress [{bar}] {percentage}% | {value}/{total}"},e);return r.start(n,0),new Promise((e=>{const n=setInterval((()=>{t++,r.update(t),t>=r.getTotal()&&(clearInterval(n),r.stop(),e(i))}),a)}))}}.waitProgress().then((()=>{n.cd(t.getSrcSolutionPath()),n.exec(`dotnet sln add ./Plugins/${t.getOutPluginName(e)}`),i(l["002"])}))):c(l["001"])}))}async clearPlugin(e){let t=this;return new Promise((async(a,s)=>{t.existOutProjectAsync(e).then((s=>{s&&n.rm("-r",t.getFullSrcPlugin(e)),a(s)})).catch((e=>{s(e)}))}))}async createProjectAsync(e,t){let n=this;return new Promise((async(a,s)=>{await n.copyFiles(t,e).then((async t=>{t?await n.replaceContentFiles(e).then((async t=>{t?n.addSolution(e).then((async e=>{a(e)})).catch((e=>{s(e)})):s(l["001"])})).catch((e=>{s(e)})):s(l["001"])})).catch((e=>{s(e)}))}))}async TryToCreate(e,t){let n=this;return new Promise((async(a,s)=>{n.createProjectAsync(e,t).then((e=>{a(e)})).catch((()=>{n.clearPlugin(e).then((e=>{a(l[e?"002":"001"])})).catch((e=>{s(e)}))}))}))}async CreateAsync(e,t){let n=this;return new Promise((async(a,s)=>{n.existOutProjectAsync(e.argv).then((async i=>{!1===i?n.TryToCreate(e.argv,t).then((e=>{a(e)})).catch((e=>{s(e)})):e.argv.c?n.clearPlugin(e.argv).then((i=>{n.TryToCreate(e.argv,t,i).then((e=>{a(e)})).catch((e=>{s(e)}))})):s(l["001"])})).catch((e=>{s(e)}))}))}async Build(e){let t=this;return new Promise((async(a,s)=>{await t.existOutProjectAsync(e.argv)?(n.cd(t.getSrcPluginName(e.argv)),n.exec(`dotnet build ${t.getOutPluginName(e.argv)}.csproj`),a(l["003"])):s(l["004"])}))}}let{build:o,create:g}=new class{async create(e){i.getPath().then((async t=>{await(new c).CreateAsync(e,t).then((e=>{r.printHandler(null,e)})).catch((e=>{r.printHandler(e,null)}))}))}async build(e){i.getPath().then((async t=>{await(new c).Build(e,t).then((e=>{r.printHandler(null,e)})).catch((e=>{r.printHandler(e,null)}))}))}};e.usage("$0 command").option("g",i.getGroupAlias()).option("p",i.getPluginAlias()).option("v",i.getVersionAlias()).option("c",i.getClearAlias()).command("new",i.getDescriptionNewCommand(),(e=>g(e))).command("build",i.getDescriptionBuildCommand(),(e=>o(e))).demand(1,i.getDescriptionDemand()).showHelpOnFail(!0).help("h").alias("h","help").argv;
