#! /usr/bin/env node
import e from"yargs";import{getInstalledPath as t}from"get-installed-path";import n from"shelljs";import a from"fs";import i from"cli-progress";class s{static getPath(){return new Promise((e=>{t("nopcli").then((t=>{e(void 0!==t?t:"./")})).catch((()=>{e("./")}))}))}static getGroupAlias(){return{alias:"group",type:"string",default:"Widgets",describe:"support Widgets, Payments, DiscountRules, Shipping and Misc"}}static getVersionAlias(){return{alias:"version",type:"number",default:430,describe:'Only support ["4.20", "4.30", "4.40", "4.50"]'}}static getPluginAlias(){return{alias:"plugin",type:"string"}}static getClearAlias(){return{alias:"clear",type:"boolean",default:!1}}static getBuildAlias(){return{alias:"build",type:"boolean",default:!1}}static getInitAlias(){return{alias:"init",type:"boolean",default:!1}}static getDescriptionNewCommand(){return"create plugin -[g] -[p] -[v] -[c] -[b] -[i]"}static getDescriptionBuildCommand(){return"build plugin -[g] -[p]"}static getDescriptionInitCommand(){return"init plugin -[g] -[p] -[v] -[b]"}static getDescriptionDemand(){return"please choose a valid command"}static getCloneNopDefaultCommand(){return"git clone https://github.com/nopSolutions/nopCommerce.git ./ --branch release-4.30 --depth 1"}static getGitNopCommercePath(){return"./.git"}static getDotNetAlias(){return{alias:"dotnet",type:"boolean",default:!1}}}class r{static printHandler(e,t,a){let i=e,s=t;i?void 0===i.code?n.echo(`${i}\n`):n.echo(`${i.code}: ${i.message}\n`):void 0===s.message?n.echo(`${s}\n`):n.echo(`${s.message}\n`),a&&n.exit(a)}}let l;l={"001":{message:'The plugin: "{{nopCli}}" already exists!',code:"001"},"002":{message:'The plugin: "{{nopCli}}" was created successfully!',code:"002"},"003":{message:"There was an error while building the plugin, please check and try again!",code:"003"},"004":{message:"Plugin build was successful!",code:"004"},"005":{message:"There was an error while getting the path value, please check and try again!",code:"005"},"006":{message:'Creating the plugin: "{{nopCli}}", Please Wait...',code:"006"}};class c{static waitProgress(e=i.Presets.shades_classic,t=0,a=100,s=10){let r=this,l=new i.Bar({format:"progress [{bar}] {percentage}%"},e);return l.start(a,0),new Promise((e=>{const a=setInterval((()=>{t++,l.update(t),t>=l.getTotal()&&(clearInterval(a),l.stop(),n.echo(""),e(r))}),s)}))}static waitInfinityProgress(e,t=!0,a=!1,s=i.Presets.rect,r=0,l=100,c=500){n.config.silent=t;let o=new i.Bar({clearOnComplete:a,format:"progress [{bar}]"},i.Presets.rect);o.start(l,r),e(o);const g=setInterval((function(){r++,o.update(r),r===l&&(l*=2,o.setTotal(l)),r>=o.getTotal()&&clearInterval(g)}),c)}}const o=new class{getSrcPluginName(e){return`Nop.Plugin.${e.g}.NopCliGeneric`}getOutPluginName(e){return`Nop.Plugin.${e.g}.${e.p}`}getFullSrcPlugin(e){return`${this.getSrcSolutionPath()}/Plugins/${this.getOutPluginName(e)}`}getSrcSolutionPath(){return a.existsSync("Plugins")?".":"src"}async validateVersion(e){let t=this.getSrcSolutionPath();return await a.existsSync(`${t}/Libraries/Nop.Services/Plugins/Samples/uploadedItems.json`)&&a.readFile(`${t}/Libraries/Nop.Services/Plugins/Samples/uploadedItems.json`,"utf8",((t,n)=>{if(t)throw t;let a=JSON.parse(n.replace(new RegExp("//(.*)","g"),""));e=a[3].SupportedVersion})),e}async getSrcVersion(e){let t=void 0!==e.v&&420!==e.v?450===e.v?440:e.v:430;return await this.validateVersion(t)}getOutProjectPathPluginName(e){return`${this.getFullSrcPlugin(e)}/${this.getOutPluginName(e)}.csproj`}async existOutProjectAsync(e){let t=this;return new Promise((async(n,i)=>{let s=t.getOutProjectPathPluginName(e);void 0===s?i(l["005"]):n(await a.existsSync(s))}))}async copyFiles(e,t){let i=this;return new Promise((async s=>{let r=i.getFullSrcPlugin(t),l=i.getSrcPluginName(t),c=i.getOutPluginName(t);n.mkdir("-p",`${r}`),n.cp("-R",`${e}/src/nopCommerce-${await i.getSrcVersion(t)}/${l}/`,r),n.mv(`${r}/${l}.csproj`,`${r}/${c}.csproj`),a.readFile(`${e}/src/assets/images/logos/logo.png`,(function(e,t){e?s(!1):a.writeFile(`${r}/logo.png`,t,"base64",(function(e){e&&s(!1)}))})),s(!0)}))}async replaceContentFiles(e){let t=this;return new Promise((async i=>{let s=t.getFullSrcPlugin(e),r=n.find(`${s}`);if(r.length>0){for(const t of r)a.lstat(t,((a,i)=>{if(i.isFile()){let a=t.replace("NopCliGeneric",e.p);n.sed("-i",/NopCliGeneric/g,e.p,t),a!==t&&n.mv(`${t}`,`${a}`)}}));i(!0)}else i(!1)}))}async addSolution(e){let t=this;return new Promise((async(i,s)=>{await a.existsSync(`${t.getSrcSolutionPath()}/NopCommerce.sln`)?(r.printHandler(null,l["006"].message.replace("{{nopCli}}",t.getOutPluginName(e))),n.config.silent=!0,c.waitProgress().then((()=>{n.cd(t.getSrcSolutionPath()),n.exec(`dotnet sln add ./Plugins/${t.getOutPluginName(e)}`),i(l["002"].message.replace("{{nopCli}}",t.getOutPluginName(e)))}))):s(l["001"].message.replace("{{nopCli}}",t.getOutPluginName(e)))}))}async clearPlugin(e){let t=this;return new Promise((async(a,i)=>{t.existOutProjectAsync(e).then((i=>{i&&n.rm("-r",t.getFullSrcPlugin(e)),a(i)})).catch((e=>{i(e)}))}))}async createProjectAsync(e,t){let n=this;return new Promise((async(a,i)=>{await n.copyFiles(t,e).then((async t=>{t?await n.replaceContentFiles(e).then((async t=>{t?n.addSolution(e).then((async e=>{a(e)})).catch((e=>{i(e)})):i(l["001"].message.replace("{{nopCli}}",n.getOutPluginName(e)))})).catch((e=>{i(e)})):i(l["001"].message.replace("{{nopCli}}",n.getOutPluginName(e)))})).catch((e=>{i(e)}))}))}async TryToCreate(e,t){let n=this;return new Promise((async(a,i)=>{n.createProjectAsync(e,t).then((e=>{a(e)})).catch((()=>{n.clearPlugin(e).then((t=>{a(l[t?"002":"001"].message.replace("{{nopCli}}",n.getOutPluginName(e)))})).catch((e=>{i(e)}))}))}))}async CreateAsync(e,t){let n=this;return new Promise((async(a,i)=>{n.existOutProjectAsync(e.argv).then((async s=>{!1===s?n.TryToCreate(e.argv,t).then((e=>{a(e)})).catch((e=>{i(e)})):e.argv.c?n.clearPlugin(e.argv).then((s=>{n.TryToCreate(e.argv,t,s).then((e=>{a(e)})).catch((e=>{i(e)}))})):i(l["001"].message.replace("{{nopCli}}",n.getOutPluginName(e.argv)))})).catch((e=>{i(e)}))}))}async cloneAsync(){return new Promise((async(e,t)=>{n.which("git")?c.waitInfinityProgress((a=>{n.exec(s.getCloneNopDefaultCommand(),(function(i,r,l){a.setTotal(100),a.update(100),a.stop(),l?t(l):(n.rm("-r",s.getGitNopCommercePath()),n.exec("git init && git add *.*",(function(n,a,i){i?t(i):e(a)})))}))})):(e("Sorry, this script requires git"),n.exit(1))}))}async Build(e){let t=this;return new Promise((async(a,i)=>{await t.existOutProjectAsync(e.argv)?(n.cd(t.getSrcPluginName(e.argv)),n.exec(`dotnet build ${t.getOutPluginName(e.argv)}.csproj`),a(l["003"])):i(l["004"])}))}async Init(e,t){let n=this;return new Promise((async(a,i)=>{await n.cloneAsync().then((i=>{e.argv.p?n.createProjectAsync(e.argv,t).then((t=>{e.argv.b?n.Build(e).then((e=>{a(e)})):a(t)})):a(i)})).catch((e=>{i(e)}))}))}};class g{static async create(e){return s.getPath().then((async t=>{await o.CreateAsync(e,t).then((e=>{r.printHandler(null,e)})).catch((e=>{r.printHandler(e,null)}))}))}static async build(e){return s.getPath().then((async t=>{await o.Build(e,t).then((e=>{r.printHandler(null,e)})).catch((e=>{r.printHandler(e,null)}))}))}static async init(e){return s.getPath().then((async t=>{await o.Init(e,t).then((e=>{r.printHandler(null,e,!0)})).catch((e=>{r.printHandler(e,null,!0)}))}))}}e.usage("$0 command").option("g",s.getGroupAlias()).option("p",s.getPluginAlias()).option("v",s.getVersionAlias()).option("c",s.getClearAlias()).option("b",s.getBuildAlias()).option("i",s.getInitAlias()).option("d",s.getDotNetAlias()).command("new",s.getDescriptionNewCommand(),(e=>g.create(e))).command("build",s.getDescriptionBuildCommand(),(e=>g.build(e))).command("init",s.getDescriptionInitCommand(),(e=>g.init(e))).demand(1,s.getDescriptionDemand()).showHelpOnFail(!0).help("h").alias("h","help").argv;
