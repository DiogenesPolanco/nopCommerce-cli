#! /usr/bin/env node
import e from"yargs";import{getInstalledPath as t}from"get-installed-path";import n from"shelljs";import i from"fs";class s{static getPath(){return t("nopcli")}static getGroupAlias(){return{alias:"group",type:"string",default:"Widgets",describe:"support Widgets, Payments, DiscountRules, Shipping and Misc"}}static getVersionAlias(){return{alias:"version",type:"number",default:430,describe:'Only support ["4.20", "4.30", "4.40", "4.50"]'}}static getPluginAlias(){return{alias:"plugin",type:"string"}}static getDescriptionNewCommand(){return"create plugin -[g] -[p] -[v]"}static getDescriptionBuildCommand(){return"build plugin -[g] -[p]"}static getDescriptionDemand(){return"please choose a valid command"}}class a{static printHandler(e,t){let i=e,s=t;i?n.echo(`${i.code}:${i.message}`):n.echo(`${s.message}`)}}let r;r={"001":{message:"Error during the generation of the plugin",code:"001"},"002":{message:"The creation of the plugin was successful",code:"002"},"003":{message:"Error while building plugin",code:"003"},"004":{message:"The build of the plugin was successful",code:"004"},"005":{message:"Error while get value",code:"005"},"006":{message:"Creating the plugin, Please Wait...",code:"006"}};class l{getSrcPluginName(e){return`Nop.Plugin.${e.g}.NopCliGeneric`}getOutPluginName(e){return`Nop.Plugin.${e.g}.${e.p}`}getFullSrcPlugin(e){return`${this.getSrcSolutionPath(e)}/Plugins/${this.getOutPluginName(e)}`}getSrcSolutionPath(){return i.existsSync("Plugins")?".":"src"}async validateVersion(e){let t=this.getSrcSolutionPath();return await i.existsSync(`${t}/Libraries/Nop.Services/Plugins/Samples/uploadedItems.json`)&&i.readFile(`${t}/Libraries/Nop.Services/Plugins/Samples/uploadedItems.json`,"utf8",((t,n)=>{if(t)throw t;let i=JSON.parse(n.replace(new RegExp("//(.*)","g"),""));e=i[3].SupportedVersion})),e}async getSrcVersion(e){let t=void 0!==e.v&&420!==e.v?450===e.v?440:e.v:430;return await this.validateVersion(t)}getOutProjectPathPluginName(e){return`${this.getFullSrcPlugin(e)}/${this.getOutPluginName(e)}.csproj`}async existOutProjectAsync(e){let t=this;return new Promise((async(n,s)=>{let a=t.getOutProjectPathPluginName(e);void 0===a?s(r["005"]):n(await i.existsSync(a))}))}async copyFiles(e,t){let s=this;return new Promise((async(a,r)=>{let l=s.getFullSrcPlugin(t),c=s.getSrcPluginName(t),o=s.getOutPluginName(t);n.mkdir("-p",`${l}`),n.cp("-R",`${e}/src/nopCommerce-${await s.getSrcVersion(t)}/${c}/`,l),n.mv(`${l}/${c}.csproj`,`${l}/${o}.csproj`),await i.readFileSync(`${e}/src/assets/images/logos/logo.png`,(function(e,t){e?r(e):i.writeFile(`${l}/logos.png`,t,"base64",(function(e){e&&r(e)}))})),a(!0)}))}async replaceContentFiles(e){let t=this;return new Promise((async(s,a)=>{let r=t.getFullSrcPlugin(e),l=n.find(`${r}`);if(l.length>0){for(const t of l)i.lstat(t,((i,s)=>{if(s.isFile()){let i=t.replace("NopCliGeneric",e.p);n.sed("-i",/NopCliGeneric/g,e.p,t),i!==t&&n.mv(`${t}`,`${i}`)}}));s(!0)}else a(!1)}))}wait(e=100){return new Promise((t=>setTimeout(t,e)))}async addSolution(e){let t=this;return new Promise((async(s,l)=>{await i.existsSync(`${t.getSrcSolutionPath()}/NopCommerce.sln`)?(a.printHandler(null,r["006"]),n.config.silent=!0,t.wait().then((()=>{n.cd(t.getSrcSolutionPath()),n.exec(`dotnet sln add ./Plugins/${t.getOutPluginName(e)}`),s(r["002"])}))):l(r["001"])}))}async createProjectAsync(e,t){let n=this;return new Promise((async(i,s)=>{await n.copyFiles(t,e).then((async t=>{t?await n.replaceContentFiles(e).then((async t=>{t?n.addSolution(e).then((async e=>{i(e)})).catch((e=>{s(e)})):s(r["001"])})).catch((e=>{s(e)})):s(r["001"])})).catch((e=>{s(e)}))}))}async CreateAsync(e,t){let n=this;return new Promise((async(i,s)=>{n.existOutProjectAsync(e.argv).then((async a=>{!1===a?n.createProjectAsync(e.argv,t,a).then((e=>{i(e)})).catch((e=>{s(e)})):s(r["001"])})).catch((e=>{s(e)}))}))}async Build(e){let t=this;return new Promise((async(i,s)=>{await t.existOutProjectAsync(e.argv)?(n.cd(t.getSrcPluginName(e.argv)),n.exec(`dotnet build ${t.getOutPluginName(e.argv)}.csproj`),i(r["003"])):s(r["004"])}))}}let{build:c,create:o}=new class{async create(e){s.getPath().then((async t=>{await(new l).CreateAsync(e,t).then((e=>{a.printHandler(null,e)})).catch((e=>{a.printHandler(e,null)}))}))}async build(e){s.getPath().then((async t=>{await(new l).Build(e,t).then((e=>{a.printHandler(null,e)})).catch((e=>{a.printHandler(e,null)}))}))}};e.usage("$0 command").option("g",s.getGroupAlias()).option("p",s.getPluginAlias()).option("v",s.getVersionAlias()).command("new",s.getDescriptionNewCommand(),(e=>o(e))).command("build",s.getDescriptionBuildCommand(),(e=>c(e))).demand(1,s.getDescriptionDemand()).showHelpOnFail(!0).help("h").alias("h","help").argv;
